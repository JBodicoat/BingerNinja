using System.Collections;using System.Linq;using UnityEngine;using UnityEngine.SceneManagement;public class SceneManager_JamieG : Singleton_Jann<SceneManager_JamieG>{private GameObject m_player;private Vector3 m_checkpointOnReset;private bool m_loadLastCheckpoint = false;private DialogueManager_MarioFernandes m_dialogueManager;public float m_fadeTime = 0.8f, m_portalFadeTime = 0.8f, m_transitionTime = 1.0f;private RectTransform m_fader;private bool m_fading;private Vector2 center, below = new Vector2(0f, 1000f);public void Awake(){base.Awake();m_fader = F("Fader")?.GetComponent<RectTransform>();GameObject dialogManager = F("DialogManager");if (dialogManager != null){m_dialogueManager = dialogManager.GetComponent<DialogueManager_MarioFernandes>();}}private void Start(){FadeOut();}public void ResetLevel(){LoadCurrentLevel();}public void ResetToCheckpoint(){int checkpointLevel = SaveLoadSystem_JamieG.LoadCheckpoint().m_lastCheckpointLevel;SC(Load(checkpointLevel > 0 ? checkpointLevel : 1));}public void LoadLevel(int level){SC(Load(level));}public void LoadMainMenu(){SceneManager.LoadScene(0);}public void LoadNextLevel(){if (SceneManager.GetActiveScene().buildIndex != 0){Inventory_JoaoBeijinho inventory = F("Player").GetComponent<Inventory_JoaoBeijinho>();if(inventory.HasItem(ItemType.LiftKey, inventory.m_inventoryItems[ItemType.LiftKey])){inventory.RemoveItem(ItemType.LiftKey, inventory.m_inventoryItems[ItemType.LiftKey]);}SaveLoadSystem_JamieG.SaveInventory(inventory);}FadeIn();SC(Load(SceneManager.GetActiveScene().buildIndex + 1));}private void LoadCurrentLevel(){SC(Load(SceneManager.GetActiveScene().buildIndex));}IEnumerator Load(int level){yield return new WaitForSeconds(m_transitionTime);SceneManager.LoadScene(level);SceneManager.sceneLoaded += OnSceneLoaded;}private void OnSceneLoaded(Scene scene, LoadSceneMode mode){if (!m_loadLastCheckpoint){return;}LoadGameState();LoadSoundSettings();if (m_player == null){m_player = GameObject.FindWithTag("Player");}m_player.transform.position = m_checkpointOnReset;m_loadLastCheckpoint = false;}public void SaveGameState(){GameObject player = F("Player");if (player != null){Inventory_JoaoBeijinho inventory = player.GetComponent<Inventory_JoaoBeijinho>();SaveLoadSystem_JamieG.SaveInventory(inventory);SaveLoadSystem_JamieG.SaveGameplay(SceneManager.GetActiveScene().buildIndex,GameObject.FindGameObjectsWithTag("Enemy"),new GameObject[0]);}}public void LoadGameState(){GameplayData gameplayData = SaveLoadSystem_JamieG.LoadGameplay();GameObject[] enemies = GameObject.FindGameObjectsWithTag("Enemy");foreach (var enemy in enemies){if (!gameplayData.m_enemyIds.Contains(enemy.name)){enemy.SetActive(false);}}}public void LoadSoundSettings(){SettingsData settingsData = SaveLoadSystem_JamieG.LoadSettings();if (!settingsData.Equals(default(SettingsData))){PlayTrack_Jann.Instance.UpdateMusicVolume(settingsData.m_musicVolume);PlayTrack_Jann.Instance.UpdateSfxVolume(settingsData.m_sfxVolume);}}public void FadeBoth(){m_dialogueManager.PauseGame();float fadeDelta = m_portalFadeTime / 2f;SC(FadeImage(fadeDelta, false));SC(FadeImage(fadeDelta, true, fadeDelta));}public void FadeIn(){SC(FadeImage(m_fadeTime / 2f, false));}public void FadeOut(){SC(FadeImage(m_fadeTime / 2f, true));}IEnumerator FadeImage(float fadeTime, bool fadeAway, float delay = 0f){if (m_fader == null)yield break;if (delay > 0)yield return new WaitForSeconds(delay);m_fading = true;for (float i = 0; i <= fadeTime; i += Time.deltaTime){float normalizedTime = i / fadeTime;if (fadeAway){m_fader.anchoredPosition = Vector2.Lerp(center, -below, normalizedTime);}else {m_fader.anchoredPosition = Vector2.Lerp(below, center, normalizedTime);}yield return null;}if (!m_dialogueManager.m_dialogBox.activeInHierarchy){m_dialogueManager.ResumeGame();}}}