using System.Collections;using System.Collections.Generic;using UnityEngine;using UnityEngine.Tilemaps;public enum state { WONDER, CHASE, ATTACK, CURIOUS };public enum m_enemyType { NORMAL, CHEF, BARISTA, INTERN, NINJA, BUSSINESMAN, PETTIGER, ALIEN, TIGERBOSS, SPACENINJABOSS, TADASHI, CHEFBOSS };public enum m_damageType { MELEE, RANGE, SNEAK, STUN };abstract class BaseEnemy_SebastianMol : M{public Transform m_rayCastStart;public Transform m_rayCastStartBackup;public PolygonCollider2D m_detectionCollider;public bool m_playerDetected = false;public state m_currentState = state.WONDER;public m_enemyType m_currentEnemyType;public GameObject m_questionmark;public GameObject m_excalmationmark;public Inventory_JoaoBeijinho m_inventory;public float m_notifcaionOffset;public GameObject m_dropItem;public float m_health;public float m_speed;public bool showPath = false;public Tilemap floortilemap;public Transform[] m_patrolPoints;public float m_playerMoveAllowance;public float m_deleyBetweenPatrol;public bool m_dosePatrole;public float m_outOfSightDeley;float m_lookLeftAndRightTimer = 0.5f;public float m_sneakDamageMultiplier;public float m_sneakDamageMultiplierStack;public float m_attackRange;public float m_attckRangeDevider = 1f;public float m_tiggerBossLooseTargetDistance = 2;public float m_secondPhaseStartPercentage = 0.3f;public float m_amountOfStunWhenPlayerStealthed = 3;public bool m_doseAffect = true;public float m_attackSpeedIncrease = 1.5f;internal float m_maxHealth;Pathfinder_SebastianMol q;protected List<Vector2Int> m_currentPath = new List<Vector2Int>();protected Transform m_playerTransform;protected float m_scale;Vector3 w;protected Vector3 m_startPos;protected float m_attackTimer;protected float m_outOfSightTimer;protected int m_patrolIterator = 0;protected float m_maxAttackRange;int e;float r;Transform t;Vector3 y;protected bool m_isStuned = false;float u;bool i = false;Vector3 o;protected int m_tadashiPhase = 1;HitEffectElliott aa;CameraShakeElliott s;protected bool m_showquestionMarkonce = false;PlayerSpoted_Elliott d;protected PlayerStealth_JoaoBeijinho m_playerStealthScript;int f = 1 << 8;void g(){if (m_dosePatrole){Patrol();}else {m_detectionCollider.enabled = true;if (Vector2.Distance(transform.position, m_startPos) > 0.5f){PathfindTo(m_startPos);}if(Vector2.Distance(transform.position, m_startPos) <= 0.5f) transform.localScale = new Vector3(m_scale, transform.localScale.y, transform.localScale.z);}m_showquestionMarkonce = false;}void h(){if (IsPlayerInLineOfSight()){if (Vector2.Distance(transform.position, m_playerTransform.position) < m_attackRange / m_attckRangeDevider){ClearPath(false);m_currentState = state.ATTACK;}else {PathfindTo(m_playerTransform.position);}}else {OnceLostContactEffect();i = true;if (m_currentPath.Count == 0){if (m_outOfSightTimer <= 0){i = false;m_currentState = state.WONDER;m_playerDetected = false;}else {j();m_outOfSightTimer -= Time.deltaTime;}}}}void j(){if(m_lookLeftAndRightTimer <= 0){if(transform.localScale.x > 0){transform.localScale = new Vector3(-m_scale, transform.localScale.y, transform.localScale.z);}else {transform.localScale = new Vector3(m_scale, transform.localScale.y, transform.localScale.z);}m_lookLeftAndRightTimer = u;}else {m_lookLeftAndRightTimer -= Time.deltaTime;}}abstract internal void AttackBehaviour();void k(){if (IsPlayerInLineOfSight()){if (Vector2.Distance(transform.position, m_playerTransform.position) < m_attackRange){AttackBehaviour();}else {m_currentState = state.CHASE;}m_outOfSightTimer = m_outOfSightDeley;m_playerDetected = true;}else {m_playerDetected = false;if (m_outOfSightTimer <= 0){m_currentState = state.WONDER;}else {m_outOfSightTimer -= Time.deltaTime;}}}void l(){if (Vector2.Distance( transform.position, o) < 1 )if (m_outOfSightTimer <= 0){m_currentState = state.WONDER;m_outOfSightTimer = m_outOfSightDeley;}else {m_outOfSightTimer -= Time.deltaTime;OnceLostContactEffect();}}void z(){switch (m_currentState){case state.WONDER:g();break;case state.CHASE:h();break;case state.ATTACK:k();break;case state.CURIOUS:l();break;}}protected void PlayerDetection(GameObject collision){if(collision.CompareTag("Player")){PlayerStealth_JoaoBeijinho playerStealth = collision.GetComponent<PlayerStealth_JoaoBeijinho>();if (m_currentEnemyType == m_enemyType.PETTIGER){if(!playerStealth.IsinVent()){x(collision);}}else if(!playerStealth.IsStealthed()){x(collision);}}}void x(GameObject col){m_detectionCollider.enabled = false;RaycastHit2D hit = Physics2D.Linecast(m_rayCastStart.position, col.transform.position);Debug.DrawLine(m_rayCastStart.position, col.transform.position, Color.red);if (!m_playerStealthScript.IsCrouched() && hit.collider.gameObject.CompareTag(Tags_JoaoBeijinho.m_playerTag)){m_playerDetected = true;m_playerTransform = hit.transform;m_currentState = state.ATTACK;NoticePlayerEffect();ClearPath();}else {m_detectionCollider.enabled = true;}}protected bool IsPlayerInLineOfSight(){if (m_playerTransform){m_detectionCollider.enabled = false;RaycastHit2D hit = Physics2D.Linecast(m_rayCastStart.position, m_playerTransform.position);Debug.DrawLine(m_rayCastStart.position, m_playerTransform.position, Color.red);if (hit.collider.gameObject.CompareTag("Player")){m_detectionCollider.enabled = false;return true;}else {RaycastHit2D hitTwo = Physics2D.Linecast(m_rayCastStartBackup.position, m_playerTransform.position);Debug.DrawLine(m_rayCastStartBackup.position, m_playerTransform.position, Color.red);if (hitTwo.collider.gameObject.CompareTag("Player")){m_detectionCollider.enabled = false;return true;}else {m_detectionCollider.enabled = true;return false;}}}return false;}protected void MoveToWorldPos(Vector3 destentaion){Vector2Int tileMapSpaceStart = (Vector2Int)q.m_tileMap.WorldToCell(transform.position);Vector2Int tileMapSpaceTarget = (Vector2Int)q.m_tileMap.WorldToCell(destentaion);m_currentPath = q.PathFind(tileMapSpaceStart, tileMapSpaceTarget);if(showPath){for (int i = 0; i < m_currentPath.Count; i++){floortilemap.SetTileFlags(new Vector3Int(m_currentPath[i].x, m_currentPath[i].y, 0), TileFlags.None);floortilemap.SetColor(new Vector3Int(m_currentPath[i].x, m_currentPath[i].y, 0), Color.green);}}}protected void FollowPath(){if (m_currentPath.Count == 0) return;float movementLeftOver = m_speed * Time.deltaTime;while (movementLeftOver > 0){Vector2 targetTileCenter = (Vector2)q.m_tileMap.CellToWorld(new Vector3Int( m_currentPath[0].x, m_currentPath[0].y, 0)) + ((Vector2)q.m_tileMap.cellSize / 2);targetTileCenter += new Vector2(-0.5f, 0);float distance = Vector2.Distance(transform.position, targetTileCenter);if (distance > movementLeftOver){transform.position = Vector2.MoveTowards(transform.position, targetTileCenter, movementLeftOver);movementLeftOver = 0;}else{transform.position = Vector2.MoveTowards(transform.position, targetTileCenter, distance);movementLeftOver -= distance;if (showPath) floortilemap.SetColor(new Vector3Int(m_currentPath[0].x, m_currentPath[0].y, 0), Color.white);m_currentPath.RemoveAt(0);if (m_currentPath.Count == 0) break;}}}protected void ClearPath(bool goBackToCenter = true){if (showPath){for (int i = 0; i < m_currentPath.Count; i++){floortilemap.SetColor(new Vector3Int(m_currentPath[i].x, m_currentPath[i].y, 0), Color.white);}}m_currentPath.Clear();if(goBackToCenter) m_currentPath.Add((Vector2Int)q.m_tileMap.WorldToCell(transform.position));y = Vector3.zero;}protected void Patrol(){if (t == null) return;if (t.position.x == 0 && t.position.y == 0) t = m_patrolPoints[0];if (m_currentPath.Count == 0) MoveToWorldPos(m_patrolPoints[m_patrolIterator].position);if (Vector2.Distance(transform.position, m_patrolPoints[m_patrolIterator].position) <= 0.4f) SwapPatrolPoints();FollowPath();}protected void SwapPatrolPoints(){if(m_patrolPoints.Length > 0){if (r <= 0){if (m_patrolIterator == e){m_patrolIterator = 0;t = m_patrolPoints[m_patrolIterator];}else {t = m_patrolPoints[++m_patrolIterator];}r = m_deleyBetweenPatrol;}else {r -= Time.deltaTime;}}}protected void PathfindTo(Vector3 pos){if (m_currentPath.Count == 0){MoveToWorldPos(pos);}if (y == Vector3.zero){y = pos;}if (Vector2.Distance(y, pos) > m_playerMoveAllowance){ClearPath();MoveToWorldPos(pos);}FollowPath();}public void OnDeath(){if(m_health <= 0){PlayTrack_Jann.Instance.PlaySound(AudioFiles.Sound_Damage);if (m_dropItem){Instantiate(m_dropItem, transform.position, Quaternion.identity);}gameObject.SetActive(false);m_inventory.CheckDeadEnemies();}}protected void SwapDirections(){if(!i)if(m_playerDetected){if(m_playerTransform.position.x > transform.position.x){transform.localScale = new Vector3( -m_scale, transform.localScale.y, transform.localScale.z);}else {transform.localScale = new Vector3(m_scale, transform.localScale.y, transform.localScale.z);}}else {if(w.x > transform.position.x){transform.localScale = new Vector3(m_scale, transform.localScale.y, transform.localScale.z);}else if(w.x < transform.position.x){transform.localScale = new Vector3(-m_scale, transform.localScale.y, transform.localScale.z);}w = transform.position;}}public void TakeDamage(m_damageType damageType, float damage){switch (m_currentEnemyType){case m_enemyType.NORMAL:v(damage);break;case m_enemyType.CHEF:if (damageType == m_damageType.MELEE){v(damage * 1.5f);}else {v(damage);}break;case m_enemyType.CHEFBOSS:break;case m_enemyType.BARISTA:if(m_playerTransform.position.x < transform.position.x){if(transform.localScale.x < 0) v(damage);}else if(m_playerTransform.position.x > transform.position.x){if (transform.localScale.x > 0) v(damage);}else {v(damage*0.25f);}break;case m_enemyType.NINJA:if (damageType == m_damageType.MELEE){if(m_playerDetected == false){v(damage);}else{v(damage * 0.5f);}}else {v(damage);}break;case m_enemyType.BUSSINESMAN:case m_enemyType.INTERN:Debug.Log(m_playerDetected);if (m_playerDetected == false){m_health -= damage * (m_sneakDamageMultiplier + m_sneakDamageMultiplierStack);aa.StartHitEffect(true);}else {m_health -= damage;aa.StartHitEffect(false);}break;case m_enemyType.SPACENINJABOSS:if ((m_health / m_maxHealth) <= m_secondPhaseStartPercentage){v(damage);m_attackTimer *= m_attackSpeedIncrease;m_doseAffect = false;m_sneakDamageMultiplierStack = 0;}else {if (m_playerDetected == false){m_health -= damage * (m_sneakDamageMultiplier + m_sneakDamageMultiplierStack);aa.StartHitEffect(true);}else {m_health -= damage;aa.StartHitEffect(false);}}break;case m_enemyType.TADASHI:float healthPercentage = m_health / m_maxHealth;if (healthPercentage > 0.6f){m_tadashiPhase = 1;v(damage);}else if( healthPercentage > 0.3f){m_tadashiPhase = 2;m_health -= damage;}else {m_tadashiPhase = 3;m_health -= damage;}break;default:v(damage);break;}m_currentState = state.CHASE;OnDeath();}void c(){m_isStuned = !m_isStuned;}public IEnumerator StunEnemyWithDeley(float amountOfTime){c();yield return new WaitForSeconds(amountOfTime);c();}public void StunEnemyWithDeleyFunc(float amaountOfTime){if(m_currentEnemyType != m_enemyType.ALIEN) SC(StunEnemyWithDeley(amaountOfTime));}public void StunEnemyWithLightsDeleyFunc(float amaountOfTime){SC(StunEnemyWithDeley(amaountOfTime));}void v( float damage ){if (m_playerDetected == false){m_health -= damage * m_sneakDamageMultiplier;s.StartShake();aa.StartHitEffect(true);m_inventory.GiveItem(ItemType.NinjaPoints, 1);}else {m_health -= damage;aa.StartHitEffect(false);}}public void ForceCuriosity(Vector3 pos){ClearPath(false);m_currentState = state.CURIOUS;o = pos;PathfindTo(o);}public void NoticePlayerEffect(){GameObject excalm = Instantiate(m_excalmationmark, new Vector3(transform.position.x,transform.position.y + m_notifcaionOffset,transform.position.z), Quaternion.identity);excalm.transform.parent = transform;}public void OnceLostContactEffect(){if (!m_showquestionMarkonce){GameObject A = Instantiate(m_questionmark, new Vector3(transform.position.x, transform.position.y + m_notifcaionOffset, transform.position.z), Quaternion.identity);A.transform.parent = transform;m_showquestionMarkonce = true;}}public void ForceLooseIntrest(){transform.position = m_startPos;i = false;m_currentState = state.WONDER;m_playerDetected = false;m_outOfSightTimer = m_outOfSightDeley;OnceLostContactEffect();}void Start(){q = FOT<Pathfinder_SebastianMol>();m_scale = transform.localScale.x;w = transform.position;m_startPos = transform.position;e = m_patrolPoints.Length-1;r = m_deleyBetweenPatrol;if (m_patrolPoints.Length > 0) t = m_patrolPoints[0];u = m_lookLeftAndRightTimer;m_maxHealth = m_health;m_outOfSightTimer = m_outOfSightDeley;m_maxAttackRange = m_attackRange;m_inventory = F("Player").GetComponent<Inventory_JoaoBeijinho>();m_playerStealthScript = FOT<PlayerStealth_JoaoBeijinho>();aa = GetComponent<HitEffectElliott>();s = Camera.main.GetComponent<CameraShakeElliott>();}void Update(){if(!m_isStuned){z();FollowPath();SwapDirections();}}void OnTriggerEnter2D(Collider2D collision){if(!m_isStuned)if(!m_playerDetected){PlayerDetection(collision.gameObject);}}void OnTriggerStay2D(Collider2D collision){if (!m_isStuned)if (!m_playerDetected){PlayerDetection(collision.gameObject);}}}