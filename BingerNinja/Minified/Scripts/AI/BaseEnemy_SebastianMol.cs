using System.Collections;using System.Collections.Generic;using UnityEngine;using UnityEngine.Tilemaps;public enum state { WONDER, CHASE, ATTACK, CURIOUS };public enum m_enemyType { NORMAL, CHEF, BARISTA, INTERN, NINJA, BUSSINESMAN, PETTIGER, ALIEN, TIGERBOSS, SPACENINJABOSS, TADASHI, CHEFBOSS };public enum m_damageType { MELEE, RANGE, SNEAK, STUN };abstract class BaseEnemy_SebastianMol : M{public Transform m_rayCastStart;public Transform m_rayCastStartBackup;public PolygonCollider2D m_detectionCollider;public bool m_playerDetected = false;public state m_currentState = state.WONDER;public m_enemyType m_currentEnemyType;public GameObject m_questionmark;public GameObject m_excalmationmark;public Inventory_JoaoBeijinho m_inventory;public float m_notifcaionOffset;public GameObject m_dropItem;public float m_health;public float m_speed;public bool showPath = false;public Tilemap floortilemap;public Transform[] m_patrolPoints;public float m_playerMoveAllowance;public float m_deleyBetweenPatrol;public bool m_dosePatrole;public float m_outOfSightDeley;private float m_lookLeftAndRightTimer = 0.5f;public float m_sneakDamageMultiplier;public float m_sneakDamageMultiplierStack;public float m_attackRange;public float m_attckRangeDevider = 1f;public float m_tiggerBossLooseTargetDistance = 2;public float m_secondPhaseStartPercentage = 0.3f;public float m_amountOfStunWhenPlayerStealthed = 3;public bool m_doseAffect = true;public float m_attackSpeedIncrease = 1.5f;internal float m_maxHealth;private Pathfinder_SebastianMol m_pathfinder;protected List<Vector2Int> m_currentPath = new List<Vector2Int>();protected Transform m_playerTransform;protected float m_scale;private Vector3 m_lastPos;protected Vector3 m_startPos;protected float m_attackTimer;protected float m_outOfSightTimer;protected int m_patrolIterator = 0;protected float m_maxAttackRange;private int m_patrolIteratorMax;private float m_patroleTimer;private Transform m_currentPatrolePos;private Vector3 m_lastPathFinfToPos;protected bool m_isStuned = false;private float m_lookLeftAndRightTimerMax;private bool m_isSerching = false;private Vector3 m_curiousTarget;protected int m_tadashiPhase = 1;private HitEffectElliott m_HitEffectElliott;private CameraShakeElliott m_cameraShake;protected bool m_showquestionMarkonce = false;private PlayerSpoted_Elliott playerSpoted_Elliott;protected PlayerStealth_JoaoBeijinho m_playerStealthScript;private int m_crouchObjectLayer = 1 << 8;private void WonderState(){if (m_dosePatrole){Patrol();}else {m_detectionCollider.enabled = true;if (Vector2.Distance(transform.position, m_startPos) > 0.5f){PathfindTo(m_startPos);}if(Vector2.Distance(transform.position, m_startPos) <= 0.5f) transform.localScale = new Vector3(m_scale, transform.localScale.y, transform.localScale.z);}m_showquestionMarkonce = false;}private void ChaseState(){if (IsPlayerInLineOfSight()){if (Vector2.Distance(transform.position, m_playerTransform.position) < m_attackRange / m_attckRangeDevider){ClearPath(false);m_currentState = state.ATTACK;}else {PathfindTo(m_playerTransform.position);}}else {OnceLostContactEffect();m_isSerching = true;if (m_currentPath.Count == 0){if (m_outOfSightTimer <= 0){m_isSerching = false;m_currentState = state.WONDER;m_playerDetected = false;}else {LookLeftAndRight();m_outOfSightTimer -= Time.deltaTime;}}}}private void LookLeftAndRight(){if(m_lookLeftAndRightTimer <= 0){if(transform.localScale.x > 0){transform.localScale = new Vector3(-m_scale, transform.localScale.y, transform.localScale.z);}else {transform.localScale = new Vector3(m_scale, transform.localScale.y, transform.localScale.z);}m_lookLeftAndRightTimer = m_lookLeftAndRightTimerMax;}else {m_lookLeftAndRightTimer -= Time.deltaTime;}}abstract internal void AttackBehaviour();private void AttackState(){if (IsPlayerInLineOfSight()){if (Vector2.Distance(transform.position, m_playerTransform.position) < m_attackRange){AttackBehaviour();}else {m_currentState = state.CHASE;}m_outOfSightTimer = m_outOfSightDeley;m_playerDetected = true;}else {m_playerDetected = false;if (m_outOfSightTimer <= 0){m_currentState = state.WONDER;}else {m_outOfSightTimer -= Time.deltaTime;}}}private void CuriousState(){if (Vector2.Distance( transform.position, m_curiousTarget) < 1 )if (m_outOfSightTimer <= 0){m_currentState = state.WONDER;m_outOfSightTimer = m_outOfSightDeley;}else {m_outOfSightTimer -= Time.deltaTime;OnceLostContactEffect();}}private void AILogic(){switch (m_currentState){case state.WONDER:WonderState();break;case state.CHASE:ChaseState();break;case state.ATTACK:AttackState();break;case state.CURIOUS:CuriousState();break;}}protected void PlayerDetection(GameObject collision){if(collision.CompareTag("Player")){PlayerStealth_JoaoBeijinho playerStealth = collision.GetComponent<PlayerStealth_JoaoBeijinho>();if (m_currentEnemyType == m_enemyType.PETTIGER){if(!playerStealth.IsinVent()){PlayerDetectionRaycasLogic(collision);}}else if(!playerStealth.IsStealthed()){PlayerDetectionRaycasLogic(collision);}}}private void PlayerDetectionRaycasLogic(GameObject col){m_detectionCollider.enabled = false;RaycastHit2D hit = Physics2D.Linecast(m_rayCastStart.position, col.transform.position);Debug.DrawLine(m_rayCastStart.position, col.transform.position, Color.red);if (!m_playerStealthScript.IsCrouched() && hit.collider.gameObject.CompareTag(Tags_JoaoBeijinho.m_playerTag)){m_playerDetected = true;m_playerTransform = hit.transform;m_currentState = state.ATTACK;NoticePlayerEffect();ClearPath();}else {m_detectionCollider.enabled = true;}}protected bool IsPlayerInLineOfSight(){if (m_playerTransform){m_detectionCollider.enabled = false;RaycastHit2D hit = Physics2D.Linecast(m_rayCastStart.position, m_playerTransform.position);Debug.DrawLine(m_rayCastStart.position, m_playerTransform.position, Color.red);if (hit.collider.gameObject.CompareTag("Player")){m_detectionCollider.enabled = false;return true;}else {RaycastHit2D hitTwo = Physics2D.Linecast(m_rayCastStartBackup.position, m_playerTransform.position);Debug.DrawLine(m_rayCastStartBackup.position, m_playerTransform.position, Color.red);if (hitTwo.collider.gameObject.CompareTag("Player")){m_detectionCollider.enabled = false;return true;}else {m_detectionCollider.enabled = true;return false;}}}return false;}protected void MoveToWorldPos(Vector3 destentaion){Vector2Int tileMapSpaceStart = (Vector2Int)m_pathfinder.m_tileMap.WorldToCell(transform.position);Vector2Int tileMapSpaceTarget = (Vector2Int)m_pathfinder.m_tileMap.WorldToCell(destentaion);m_currentPath = m_pathfinder.PathFind(tileMapSpaceStart, tileMapSpaceTarget);if(showPath){for (int i = 0; i < m_currentPath.Count; i++){floortilemap.SetTileFlags(new Vector3Int(m_currentPath[i].x, m_currentPath[i].y, 0), TileFlags.None);floortilemap.SetColor(new Vector3Int(m_currentPath[i].x, m_currentPath[i].y, 0), Color.green);}}}protected void FollowPath(){if (m_currentPath.Count == 0) return;float movementLeftOver = m_speed * Time.deltaTime;while (movementLeftOver > 0){Vector2 targetTileCenter = (Vector2)m_pathfinder.m_tileMap.CellToWorld(new Vector3Int( m_currentPath[0].x, m_currentPath[0].y, 0)) + ((Vector2)m_pathfinder.m_tileMap.cellSize / 2);targetTileCenter += new Vector2(-0.5f, 0);float distance = Vector2.Distance(transform.position, targetTileCenter);if (distance > movementLeftOver){transform.position = Vector2.MoveTowards(transform.position, targetTileCenter, movementLeftOver);movementLeftOver = 0;}else{transform.position = Vector2.MoveTowards(transform.position, targetTileCenter, distance);movementLeftOver -= distance;if (showPath) floortilemap.SetColor(new Vector3Int(m_currentPath[0].x, m_currentPath[0].y, 0), Color.white);m_currentPath.RemoveAt(0);if (m_currentPath.Count == 0) break;}}}protected void ClearPath(bool goBackToCenter = true){if (showPath){for (int i = 0; i < m_currentPath.Count; i++){floortilemap.SetColor(new Vector3Int(m_currentPath[i].x, m_currentPath[i].y, 0), Color.white);}}m_currentPath.Clear();if(goBackToCenter) m_currentPath.Add((Vector2Int)m_pathfinder.m_tileMap.WorldToCell(transform.position));m_lastPathFinfToPos = Vector3.zero;}protected void Patrol(){if (m_currentPatrolePos == null) return;if (m_currentPatrolePos.position.x == 0 && m_currentPatrolePos.position.y == 0) m_currentPatrolePos = m_patrolPoints[0];if (m_currentPath.Count == 0) MoveToWorldPos(m_patrolPoints[m_patrolIterator].position);if (Vector2.Distance(transform.position, m_patrolPoints[m_patrolIterator].position) <= 0.4f) SwapPatrolPoints();FollowPath();}protected void SwapPatrolPoints(){if(m_patrolPoints.Length > 0){if (m_patroleTimer <= 0){if (m_patrolIterator == m_patrolIteratorMax){m_patrolIterator = 0;m_currentPatrolePos = m_patrolPoints[m_patrolIterator];}else {m_currentPatrolePos = m_patrolPoints[++m_patrolIterator];}m_patroleTimer = m_deleyBetweenPatrol;}else {m_patroleTimer -= Time.deltaTime;}}}protected void PathfindTo(Vector3 pos){if (m_currentPath.Count == 0){MoveToWorldPos(pos);}if (m_lastPathFinfToPos == Vector3.zero){m_lastPathFinfToPos = pos;}if (Vector2.Distance(m_lastPathFinfToPos, pos) > m_playerMoveAllowance){ClearPath();MoveToWorldPos(pos);}FollowPath();}public void OnDeath(){if(m_health <= 0){PlayTrack_Jann.Instance.PlaySound(AudioFiles.Sound_Damage);if (m_dropItem){Instantiate(m_dropItem, transform.position, Quaternion.identity);}gameObject.SetActive(false);m_inventory.CheckDeadEnemies();}}protected void SwapDirections(){if(!m_isSerching)if(m_playerDetected){if(m_playerTransform.position.x > transform.position.x){transform.localScale = new Vector3( -m_scale, transform.localScale.y, transform.localScale.z);}else {transform.localScale = new Vector3(m_scale, transform.localScale.y, transform.localScale.z);}}else {if(m_lastPos.x > transform.position.x){transform.localScale = new Vector3(m_scale, transform.localScale.y, transform.localScale.z);}else if(m_lastPos.x < transform.position.x){transform.localScale = new Vector3(-m_scale, transform.localScale.y, transform.localScale.z);}m_lastPos = transform.position;}}public void TakeDamage(m_damageType damageType, float damage){switch (m_currentEnemyType){case m_enemyType.NORMAL:NormalTakeDamage(damage);break;case m_enemyType.CHEF:if (damageType == m_damageType.MELEE){NormalTakeDamage(damage * 1.5f);}else {NormalTakeDamage(damage);}break;case m_enemyType.CHEFBOSS:break;case m_enemyType.BARISTA:if(m_playerTransform.position.x < transform.position.x){if(transform.localScale.x < 0) NormalTakeDamage(damage);}else if(m_playerTransform.position.x > transform.position.x){if (transform.localScale.x > 0) NormalTakeDamage(damage);}else {NormalTakeDamage(damage*0.25f);}break;case m_enemyType.NINJA:if (damageType == m_damageType.MELEE){if(m_playerDetected == false){NormalTakeDamage(damage);}else{NormalTakeDamage(damage * 0.5f);}}else {NormalTakeDamage(damage);}break;case m_enemyType.BUSSINESMAN:case m_enemyType.INTERN:Debug.Log(m_playerDetected);if (m_playerDetected == false){m_health -= damage * (m_sneakDamageMultiplier + m_sneakDamageMultiplierStack);m_HitEffectElliott.StartHitEffect(true);}else {m_health -= damage;m_HitEffectElliott.StartHitEffect(false);}break;case m_enemyType.SPACENINJABOSS:if ((m_health / m_maxHealth) <= m_secondPhaseStartPercentage){NormalTakeDamage(damage);m_attackTimer *= m_attackSpeedIncrease;m_doseAffect = false;m_sneakDamageMultiplierStack = 0;}else {if (m_playerDetected == false){m_health -= damage * (m_sneakDamageMultiplier + m_sneakDamageMultiplierStack);m_HitEffectElliott.StartHitEffect(true);}else {m_health -= damage;m_HitEffectElliott.StartHitEffect(false);}}break;case m_enemyType.TADASHI:float healthPercentage = m_health / m_maxHealth;if (healthPercentage > 0.6f){m_tadashiPhase = 1;NormalTakeDamage(damage);}else if( healthPercentage > 0.3f){m_tadashiPhase = 2;m_health -= damage;}else {m_tadashiPhase = 3;m_health -= damage;}break;default:NormalTakeDamage(damage);break;}m_currentState = state.CHASE;OnDeath();}private void StunEnemyToggle(){m_isStuned = !m_isStuned;}public IEnumerator StunEnemyWithDeley(float amountOfTime){StunEnemyToggle();yield return new WaitForSeconds(amountOfTime);StunEnemyToggle();}public void StunEnemyWithDeleyFunc(float amaountOfTime){if(m_currentEnemyType != m_enemyType.ALIEN) SC(StunEnemyWithDeley(amaountOfTime));}public void StunEnemyWithLightsDeleyFunc(float amaountOfTime){SC(StunEnemyWithDeley(amaountOfTime));}private void NormalTakeDamage( float damage ){if (m_playerDetected == false){m_health -= damage * m_sneakDamageMultiplier;m_cameraShake.StartShake();m_HitEffectElliott.StartHitEffect(true);m_inventory.GiveItem(ItemType.NinjaPoints, 1);}else {m_health -= damage;m_HitEffectElliott.StartHitEffect(false);}}public void ForceCuriosity(Vector3 pos){ClearPath(false);m_currentState = state.CURIOUS;m_curiousTarget = pos;PathfindTo(m_curiousTarget);}public void NoticePlayerEffect(){Debug.Log("!");GameObject excalm = Instantiate(m_excalmationmark, new Vector3(transform.position.x,transform.position.y + m_notifcaionOffset,transform.position.z), Quaternion.identity);excalm.transform.parent = transform;}public void OnceLostContactEffect(){if (!m_showquestionMarkonce){Debug.Log("?");GameObject A = Instantiate(m_questionmark, new Vector3(transform.position.x, transform.position.y + m_notifcaionOffset, transform.position.z), Quaternion.identity);A.transform.parent = transform;m_showquestionMarkonce = true;}}public void ForceLooseIntrest(){transform.position = m_startPos;m_isSerching = false;m_currentState = state.WONDER;m_playerDetected = false;m_outOfSightTimer = m_outOfSightDeley;OnceLostContactEffect();}private void Start(){m_pathfinder = FOT<Pathfinder_SebastianMol>();m_scale = transform.localScale.x;m_lastPos = transform.position;m_startPos = transform.position;m_patrolIteratorMax = m_patrolPoints.Length-1;m_patroleTimer = m_deleyBetweenPatrol;if (m_patrolPoints.Length > 0) m_currentPatrolePos = m_patrolPoints[0];m_lookLeftAndRightTimerMax = m_lookLeftAndRightTimer;m_maxHealth = m_health;m_outOfSightTimer = m_outOfSightDeley;m_maxAttackRange = m_attackRange;m_inventory = F("Player").GetComponent<Inventory_JoaoBeijinho>();m_playerStealthScript = FOT<PlayerStealth_JoaoBeijinho>();m_HitEffectElliott = GetComponent<HitEffectElliott>();m_cameraShake = Camera.main.GetComponent<CameraShakeElliott>();}private void Update(){if(!m_isStuned){AILogic();FollowPath();SwapDirections();}}private void OnTriggerEnter2D(Collider2D collision){if(!m_isStuned)if(!m_playerDetected){PlayerDetection(collision.gameObject);}}private void OnTriggerStay2D(Collider2D collision){if (!m_isStuned)if (!m_playerDetected){PlayerDetection(collision.gameObject);}}}